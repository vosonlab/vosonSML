#' @title Add columns of user information as node attributes to network dataframes
#'
#' @description Network is supplemented with additional downloaded social media user information applied as node
#' attributes.
#'
#' @note Only supports twitter actor networks. Refer to \code{\link{AddUserData.actor.twitter}}.
#'
#' @param net A named list of dataframes \code{nodes} and \code{edges} generated by \code{Create}.
#' @param data A dataframe generated by \code{Collect}.
#' @param ... Additional parameters passed to function.
#'
#' @return Network as a named list of two dataframes containing \code{$nodes} and \code{$edges}
#' including columns for additional user data.
#'
#' @aliases AddUserData
#' @name AddUserData
#' @export
AddUserData <- function(net, data, ...) {
  msg <- f_verbose(list(...)$verbose)

  # searches the class list of net for matching method
  UseMethod("AddUserData", net)
}

#' @noRd
#' @export
AddUserData.default <- function(net, ...) {
  stop("Unknown network type passed to AddUserData.", call. = FALSE)
}

#' @noRd
#' @method AddUserData actor
#' @export
AddUserData.actor <- function(net, ...) {
  UseMethod("AddUserData.actor", net)
}

#' @noRd
#' @export
AddUserData.actor.default <- function(net, ...) {
  stop("Unknown social media type passed to AddUserData.", call. = FALSE)
}

#' @title Supplement twitter actor network by adding user profile attributes to nodes
#'
#' @description Network is supplemented with additional downloaded user information applied as actor node attributes.
#'
#' @note Using the standard twitter API this function is limited to collecting profiles of 90000 users per 15 mins
#' before hitting the rate limit. It does not wait and retry upon hitting rate limit.
#'
#' @param net A named list of dataframes \code{nodes} and \code{edges} generated by \code{Create}.
#' @param data A dataframe generated by \code{Collect}.
#' @param rmMisc Logical. Remove miscellaneous user data columns such as user profile colors and other visual
#' elements. Default is \code{TRUE}.
#' @param verbose Logical. Output additional information. Default is \code{FALSE}.
#' @param ... Additional parameters passed to function. Not used in this method.
#'
#' @examples
#' \dontrun{
#' # add user info to a twitter actor network
#' actor_net <- twitter_data |>
#'   Create("actor") |>
#'   AddUserData(twitter_data)
#' }
#'
#' @return Network as a named list of two dataframes containing \code{$nodes}, \code{$edges}. Nodes include
#' columns for additional user profile data and metrics. Referenced users for which no data was found are returned in an
#' object attribute named \code{missing_users}.
#'
#' @aliases AddUserData.actor.twitter
#' @name AddUserData.actor.twitter
#' @export
AddUserData.actor.twitter <-
  function(net,
           data,
           rmMisc = TRUE,
           verbose = FALSE,
           ...) {
    rlang::check_installed("rtweet", "for AddUserData.actor.twitter")
    stop_req_pkgs(c("rtweet"), "AddUserData.actor.twitter")

    msg("Adding user profile data to network...\n")

    users <- attr(data, "users", exact = TRUE)
    if (is.null(users)) {
      stop("No user data found.")
    }

    users <- users |>
      twitter_user_transforms(rm_misc = rmMisc)

    qs_users <- extract_nested_twitter_users(data, "qs") |>
      twitter_user_transforms(rm_misc = rmMisc) |>
      dplyr::distinct(.data$u.user_id, .keep_all = TRUE)

    rts_users <- extract_nested_twitter_users(data, "rts") |>
      twitter_user_transforms(rm_misc = rmMisc) |>
      dplyr::distinct(.data$u.user_id, .keep_all = TRUE)

    all_users <- dplyr::bind_rows(users, qs_users, rts_users) |>
      dplyr::distinct(.data$u.user_id, .keep_all = TRUE)

    actor_ids <- net$nodes |> dplyr::select(.data$user_id, .data$screen_name)

    missing_user_data <-
      dplyr::anti_join(
        actor_ids,
        all_users |> dplyr::select(.data$u.user_id),
        by = c("user_id" = "u.user_id"))

    net$nodes <- net$nodes |>
      dplyr::left_join(all_users, by = c("user_id" = "u.user_id"))

    attr(net, "missing_users") <- missing_user_data

    class(net) <- union(class(net), c("vosonuser"))
    msg("Done.\n")

    net
  }

# extract users from nested tweet fields
extract_nested_twitter_users <- function(x, var) {
  x <- x |>
    dplyr::select({{ var }}) |>
    tidyr::unnest(cols = c({{ var }})) |>
    dplyr::select(.data$user) |>
    tidyr::unnest(cols = c(.data$user)) |>
    dplyr::filter(!is.na(.data$id_str)) |>
    dplyr::rename(user_id = .data$id_str)

  x
}

# transform tweet user data
twitter_user_transforms <- function(x, rm_misc = TRUE) {
  x <- x |>
    dplyr::rename(display_name = .data$name)

  # drop the following columns
  if (rm_misc) {
    x <- x |>
      dplyr::select(-.data$id,
                    -.data$entities,
                    -dplyr::starts_with(
                      c(
                        "contributors_enabled",
                        "follow_request_sent",
                        "following",
                        # "geo_enabled",
                        # "has_extended_profile",
                        "is_translation_enabled",
                        "is_translator",
                        # "lang",
                        "notifications",
                        "profile_background_color",
                        "profile_background_image_url",
                        "profile_background_image_url_https",
                        "profile_background_tile",
                        "profile_image_url",
                        "profile_link_color",
                        "profile_sidebar_border_color",
                        "profile_sidebar_fill_color",
                        "profile_text_color",
                        "profile_use_background_image",
                        # "time_zone",
                        "translator_type"
                        # "utc_offset"
                      )))
  } else {
    x$entities <- list(x$entities)
  }

  api_dt_fmt <- twitter_api_dt_fmt()

  x <- x |>
    dplyr::mutate(
      created_at = ifelse(
        is.na(.data$created_at), NA_character_,
        as.character(
          as.POSIXct(.data$created_at, format = api_dt_fmt, tz = "UTC")
        )
      )
    ) |>
    dplyr::mutate_at(dplyr::vars("created_at"),
                     lubridate::as_datetime, tz = "UTC") |>
    dplyr::rename_with(function(x) paste0("u.", x))

  x
}

